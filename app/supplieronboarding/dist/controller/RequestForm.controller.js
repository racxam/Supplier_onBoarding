sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Icon","sap/m/Link","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/ui/model/odata/v4/ODataModel"],function(e,t,a,r,i,s,n,o,l){"use strict";return e.extend("com.sumo.supplieronboarding.controller.RequestForm",{onInit:function(){var e=new sap.ui.model.json.JSONModel({documentfiles:[]});this.getView().setModel(e);this.onReadSupplierSpendType();this.onReadNatureofActivity();this.onReadSector();this.onReadDepartments();var t=new Date;var a=new Date;a.setFullYear(t.getFullYear()+4);var r=this.byId("datePicker");r.setMinDate(t);r.setMaxDate(a);var e=new sap.ui.model.json.JSONModel({panCardValue:"",gstinValue:"",emailValue:"",numberValue:"",pan:[],gst:[]});this.getView().setModel(e)},onPanCardChange:function(e){var t=e.getSource();var a=t.getValue().toUpperCase();a=a.replace(/[^A-Z0-9]/g,"");t.setValue(a);if(this._panCardDebounceTimeout){clearTimeout(this._panCardDebounceTimeout)}this._panCardDebounceTimeout=setTimeout(function(){if(a.length===10){var e=/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;if(e.test(a)){t.setValueState("Success");t.setValueStateText("")}else{t.setValueState("Error");t.setValueStateText("Invalid PAN format. It should be 5 letters, 4 numbers, and 1 letter.")}}else{t.setValueState("Error");t.setValueStateText("PAN must be exactly 10 characters long.")}},1e3)},onGSTINChange:function(e){var t=e.getSource();var a=t.getValue().toUpperCase();a=a.replace(/[^A-Z0-9]/g,"");t.setValue(a);var r=this.getView().getModel().getProperty("/panCardValue");if(this._gstinDebounceTimeout){clearTimeout(this._gstinDebounceTimeout)}this._gstinDebounceTimeout=setTimeout(function(){if(a.length===15){var e=/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;if(e.test(a)){var i=a.substring(2,12);if(i===r){t.setValueState("Success");t.setValueStateText("")}else{t.setValueState("Error");t.setValueStateText("The PAN part of the GSTIN does not match the entered PAN.")}}else{t.setValueState("Error");t.setValueStateText("Invalid GSTIN format. It should be 15 characters long with the correct structure.")}}else{t.setValueState("Error");t.setValueStateText("GSTIN must be exactly 15 characters long.")}},1e3)},onSubmitpan:function(){var e=this.byId("panInput");var a=e.getValue();if(e.getValueState()==="Success"){t.show("PAN Card number is valid: "+a)}else{t.show("Please enter a valid PAN Card number.")}},onSubmitgst:function(){var e=this.getView().byId("gstinInput").getValue();if(e){this.verifyGST(e)}else{a.error("Please enter a valid GSTIN.")}},verifyGST:function(e){var t=this.getView().getModel("V4odataService");t.bindContext("/getStatus()",{urlParameters:{gstin:e}}).requestObject().then(function(e){this._onpopulate(e);console.log("API data:",e)}.bind(this)).catch(function(e){console.error("Error calling backend API:",e);a.error("Error fetching GST details. Please try again.")}.bind(this))},_onpopulate:function(e){this.getView().byId("SupplierNameInput").setValue(e.value.data.lgnm);this.getView().byId("SuppliertradeNameInput").setValue(e.value.data.tradeNam)},onEmailChange:function(e){var t=e.getSource();var a=t.getValue();a=a.replace(/\s+/g,"");t.setValue(a);if(this._emailDebounceTimeout){clearTimeout(this._emailDebounceTimeout)}this._emailDebounceTimeout=setTimeout(function(){var e=/^[a-zA-Z0-9]+(?:\.[a-zA-Z0-9]+)*@[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])$/;if(a===""||!e.test(a)){t.setValueState("Error");t.setValueStateText("Invalid Email format. Please enter a valid Email.")}else{t.setValueState("Success")}},1e3)},onSubmitemail:function(){var e=this.byId("emailInput");var a=e.getValue();if(e.getValueState()==="Success"){t.show("Email is valid: "+a)}else{t.show("Please enter a valid email address.")}},onNumberChange:function(e){var t=e.getSource();var a=t.getValue();a=a.replace(/\D/g,"");if(a.length>10){a=a.substring(0,10)}t.setValue(a);if(this._numberDebounceTimeout){clearTimeout(this._numberDebounceTimeout)}this._numberDebounceTimeout=setTimeout(function(){if(a.length===10){t.setValueState("Success")}else{t.setValueState("Error");t.setValueStateText("Invalid Number. Please enter a valid Mobile Number.")}},1e3)},onSubmitnumber:function(){var e=this.byId("numberInput");var a=e.getValue();if(e.getValueState()==="Success"){t.show("Number is valid: "+a)}else{t.show("Please enter a valid Mobile number.")}},onDownload:function(e){var t=e.getSource();var a=t.getCustomData()[0].getValue();var r=t.getText();var i=document.createElement("a");i.href=a;i.download=r;document.body.appendChild(i);i.click();document.body.removeChild(i)},onDeleteFilepan:function(e){var a=e.getSource();var r=a.getParent().getParent();var i=this.getView().getModel();var s=i.getProperty("/pan");var n=r.getBindingContext().getPath().split("/").pop();s.splice(n,1);i.setProperty("/pan",s);t.show("File deleted successfully.")},onDeleteFilegst:function(e){var a=e.getSource();var r=a.getParent().getParent();var i=this.getView().getModel();var s=i.getProperty("/gst");var n=r.getBindingContext().getPath().split("/").pop();s.splice(n,1);i.setProperty("/gst",s);t.show("File deleted successfully.")},onFormsubmit:function(){var e=this.getView();var t=this.getOwnerComponent().getModel();var r=true;var i={validity:e.byId("datePicker").getValue(),relatedParty:e.byId("radioGroup").getSelectedButton(),supplierSpendType:e.byId("supplierSpendType").getSelectedKey(),natureOfActivity:e.byId("NatureofActivity").getSelectedKey(),sector:e.byId("sectorComboBox").getSelectedKeys(),FunctionandSubfunction:e.byId("childMultiComboBox").getSelectedKeys(),panCardNumber:e.byId("panInput").getValue(),gstinNumber:e.byId("gstinInput").getValue(),supplierFullName:e.byId("SupplierNameInput").getValue(),supplierTradeName:e.byId("SuppliertradeNameInput").getValue(),supplierAddress:e.byId("SupplierAddressInput").getValue(),supplierGstAddress:e.byId("SupplierAddressgstInput").getValue(),primaryFirstName:e.byId("PrimaryFirstnameInput").getValue(),primaryLastName:e.byId("PrimaryLastnameInput").getValue(),primaryEmail:e.byId("emailInput").getValue(),primaryPhone:e.byId("numberInput").getValue(),panattachment:e.byId("fileUploaderPan").getValue(),gstattachment:e.byId("fileUploaderGst").getValue()};function s(e,t,a,r,i){if(!a||typeof a==="string"&&a.trim()===""||a.length===0){e.byId(t).setValueState(sap.ui.core.ValueState.Error).setValueStateText(r);return false}else{e.byId(t).setValueState(sap.ui.core.ValueState.None);return i}}r=s(e,"datePicker",i.validity,"Date is required",r);r=s(e,"supplierSpendType",i.supplierSpendType,"Supplier Spend Type is required",r);r=s(e,"NatureofActivity",i.natureOfActivity,"Nature of Activity is required",r);r=s(e,"sectorComboBox",i.sector,"At least one sector is required",r);r=s(e,"childMultiComboBox",i.FunctionandSubfunction,"At least one function/subfunction is required",r);r=s(e,"fileUploaderPan",i.panattachment,"PAN Card Attachment is required",r);r=s(e,"fileUploaderGst",i.gstattachment,"GST Attachment is required",r);r=s(e,"SupplierNameInput",i.supplierFullName,"Supplier Full Name is required and cannot be only spaces.",r);r=s(e,"SuppliertradeNameInput",i.supplierTradeName,"Supplier Trade Name is required and cannot be only spaces.",r);r=s(e,"SupplierAddressInput",i.supplierAddress,"Supplier Address is required and cannot be only spaces.",r);r=s(e,"SupplierAddressgstInput",i.supplierGstAddress,"Supplier GST Address is required and cannot be only spaces.",r);r=s(e,"PrimaryFirstnameInput",i.primaryFirstName,"Primary First Name is required and cannot be only spaces.",r);r=s(e,"PrimaryLastnameInput",i.primaryLastName,"Primary Last Name is required and cannot be only spaces.",r);if(!i.panCardNumber||i.panCardNumber.trim()===""){e.byId("panInput").setValueState(sap.ui.core.ValueState.Error).setValueStateText("PAN Card Number is required");r=false}else{var n=i.panCardNumber.trim();var o=/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;if(!o.test(n)){e.byId("panInput").setValueState(sap.ui.core.ValueState.Error).setValueStateText("Invalid PAN Card Number format. PAN should be in the format AAAAA9999A.");r=false}else{e.byId("panInput").setValueState(sap.ui.core.ValueState.None)}}if(!i.gstinNumber||i.gstinNumber.trim()===""){var l=e.byId("gstinInput");if(l){l.setValueState(sap.ui.core.ValueState.Error).setValueStateText("GSTIN Number is required")}r=false}else{var u=i.gstinNumber.trim();var d=/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[A-Z0-9]{1}[Z]{1}[0-9]{1}$/;if(!d.test(u)){var l=e.byId("gstinInput");if(l){l.setValueState(sap.ui.core.ValueState.Error).setValueStateText("Invalid GSTIN Number format. It should be in the format 12ABCDE3456Z1Z5.")}r=false}else{var l=e.byId("gstinInput");if(l){l.setValueState(sap.ui.core.ValueState.None)}var p=u.substring(2,12);var n=i.panCardNumber;if(p===n){l.setValueState(sap.ui.core.ValueState.Success);l.setValueStateText("")}else{l.setValueState(sap.ui.core.ValueState.Error);l.setValueStateText("The PAN part of the GSTIN does not match the entered PAN.");r=false}}}if(!i.primaryEmail||i.primaryEmail.trim()===""){e.byId("emailInput").setValueState(sap.ui.core.ValueState.Error).setValueStateText("Primary Email is required");r=false}else{var c=i.primaryEmail.trim().replace(/\s+/g,"");var m=/^[a-zA-Z0-9]+(?:\.[a-zA-Z0-9]+)*@[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])$/;if(!m.test(c)){e.byId("emailInput").setValueState(sap.ui.core.ValueState.Error).setValueStateText("Invalid Primary Email format. Please enter a valid email.");r=false}else{e.byId("emailInput").setValueState(sap.ui.core.ValueState.None)}}if(!i.primaryPhone||i.primaryPhone.trim()===""){var g=e.byId("numberInput");if(g){g.setValueState(sap.ui.core.ValueState.Error).setValueStateText("Primary Phone Number is required")}r=false}else{var f=i.primaryPhone.trim();var S=/^[0-9]{10}$/;if(!S.test(f)){var g=e.byId("numberInput");if(g){g.setValueState(sap.ui.core.ValueState.Error).setValueStateText("Invalid Phone Number. It should be 10 digits.")}r=false}else{var g=e.byId("numberInput");if(g){g.setValueState(sap.ui.core.ValueState.None)}}}if(r){if(i.relatedParty.getText()==="Yes"){i.relatedParty=true}else{i.relatedParty=false}var y={DigressionVendorCodeVal:i.validity,IsRelPartyVCode:i.relatedParty,SpendType:i.supplierSpendType,NatureOfActivity:i.natureOfActivity,Sector:i.sector,FunAndSubfun:i.FunctionandSubfunction,PANCardNo:i.panCardNumber,GSTIN:i.gstinNumber,SFullName:i.supplierFullName,STradeNameGST:i.supplierTradeName,SAddress:i.supplierAddress,SAddressGST:i.supplierGstAddress,PriContactFName:i.primaryFirstName,PriContactLName:i.primaryLastName,PriContactEmail:i.primaryEmail,PriContactMNumber:i.primaryPhone};t.setUseBatch(false);var e=this;t.create("/supplierReqSrv",y,{method:"POST",success:function(t){a.success("Form submitted successfully."+t.ID);this.onUploadFile(t.ID);e.clearFormFields()}.bind(this),error:function(){a.error("Error while submitting the Form.")}})}else{a.error("Please fill All The Required fields.")}},onUploadFile:function(e){const a=(e,a)=>{e.forEach(e=>{var r={Req_Supplier_ID:a,Attachment_ID:e.attachmentId,fileName:e.fileName,mediaType:e.fileType,content:e.fileContent,Doc_Type:e.Doc_Type};var i=this.getOwnerComponent().getModel();i.setUseBatch(false);i.create("/SReqattachmentsSrv",r,{method:"POST",success:function(e){t.show("Attachments uploaded successfully: "+e.ID)}.bind(this),error:function(){t.show("Error while Uploading the Attachments.")}})})};var r=this.getView().getModel();var i=r.getProperty("/documentFiles");var s=i.pan.concat(i.gst);a(s,e)},onFileUpload:function(e){var a=e.getSource();var r=a.getValue();var i=a.oFileUpload.files[0];if(r){a.setValueState(sap.ui.core.ValueState.None)}if(i){var s=i.name;var n=s.split(".").pop();var o=new FileReader;var l=this;o.onload=function(e){var r=e.target.result;var i=l.getView().getModel();var o=i.getProperty("/documentFiles")||{pan:[],gst:[],cin:[]};var u=o.pan.length+1;var d=o.gst.length+1;var p=o.cin.length+1;var c=a.getId();var m="";var g="";if(c.includes("fileUploaderPan")){m="PAN";g=u;o.pan.push({fileName:s,fileUrl:r,fileContent:r,fileType:n,Doc_Type:"PAN",attachmentId:g})}else if(c.includes("fileUploaderGst")){m="GST";g=d;o.gst.push({fileName:s,fileUrl:r,fileContent:r,fileType:n,Doc_Type:"GST",attachmentId:g})}else if(c.includes("fileUploaderCin")){m="CIN";g=p;o.cin.push({fileName:s,fileUrl:r,fileContent:r,fileType:n,Doc_Type:"CIN",attachmentId:g})}i.setProperty("/documentFiles",o);t.show(m+" file "+s+" uploaded successfully.");i.refresh(true)};o.readAsDataURL(i)}},formatAttachmentButtonText:function(e,t){e=e||[];return"View Attachments ("+e.length+")"},onOpenDialog:function(e){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("com.sumo.supplieronboarding.view.fragment.uploadfile",this);this.getView().addDependent(this._oDialog)}var t=this.getView().getModel();var a=t.getProperty("/documentFiles/"+e)||[];var r=new sap.ui.model.json.JSONModel({documentFiles:a});this._oDialog.setModel(r);this._oDialog.data("documentType",e);this._oDialog.open()},onCloseDialog:function(){if(this._oDialog){this._oDialog.close()}},onDownloadFile:function(e){const a=e.getSource().data("fileName");const r=this._oDialog.data("documentType");var i=this.getView().getModel();var s=i.getProperty("/documentFiles/"+r);var n=s.find(e=>e.fileName===a);if(n&&n.fileContent){const e=this._base64ToBlob(n.fileContent);const t=document.createElement("a");t.href=URL.createObjectURL(e);t.download=a;t.click()}else{t.show("File not found or missing content.")}},onDeleteFile:function(e){const a=e.getSource().data("fileName");const r=this._oDialog.data("documentType");sap.m.MessageBox.confirm(`Are you sure you want to delete the file "${a}"?`,{onClose:function(e){if(e==="OK"){const e=this.getView().getModel();const i=e.getProperty("/documentFiles/"+r);const s=i.filter(e=>e.fileName!==a);e.setProperty("/documentFiles/"+r,s);t.show(`File "${a}" deleted successfully.`);if(r==="pan"){this.byId("fileUploaderPan").setValue("")}else if(r==="gst"){this.byId("fileUploaderGst").setValue("")}this.onCloseDialog()}}.bind(this)})},_base64ToBlob:function(e){if(e.startsWith("data:")){e=e.split(",")[1]}try{const t=atob(e);const a=[];for(let e=0;e<t.length;e+=512){const r=t.slice(e,e+512);const i=new Array(r.length);for(let e=0;e<r.length;e++){i[e]=r.charCodeAt(e)}const s=new Uint8Array(i);a.push(s)}return new Blob(a,{type:"application/octet-stream"})}catch(e){console.error("Base64 decoding failed: ",e);return null}},handleLiveChange:function(e){var t=e.getSource();var a=t.getValue();if(a){t.setValueState(sap.ui.core.ValueState.None)}},handleComboBoxChange:function(e){var t=e.getSource();var a=t.getSelectedKey();if(a){t.setValueState(sap.ui.core.ValueState.None)}},handleDateChange:function(e){var t=e.getSource();var a=t.getDateValue();if(a){t.setValueState(sap.ui.core.ValueState.None)}},handleFileChange:function(e){var t=e.getSource();var a=t.getValue();if(a){t.setValueState(sap.ui.core.ValueState.None)}},handleMultiComboBoxChange:function(e){var t=e.getSource();var a=t.getSelectedItems();if(a.length>0){t.setValueState(sap.ui.core.ValueState.None)}},clearFormFields:function(){var e=this.getView();e.byId("datePicker").setDateValue(null);e.byId("radioGroup").setSelectedButton(null);e.byId("supplierSpendType").setSelectedKey("");e.byId("NatureofActivity").setSelectedKey("");e.byId("sectorComboBox").setSelectedKeys([]);e.byId("childMultiComboBox").setSelectedKeys([]);e.byId("panInput").setValue("");e.byId("fileUploaderPan").setValue("");e.byId("fileUploaderGst").setValue("");e.byId("gstinInput").setValue("");e.byId("SupplierNameInput").setValue("");e.byId("SuppliertradeNameInput").setValue("");e.byId("SupplierAddressInput").setValue("");e.byId("SupplierAddressgstInput").setValue("");e.byId("PrimaryFirstnameInput").setValue("");e.byId("PrimaryLastnameInput").setValue("");e.byId("emailInput").setValue("");e.byId("numberInput").setValue("")},onReadSector:function(){var e=this;var t=this.getOwnerComponent().getModel();t.read("/SectorSrv",{success:function(t){var a=new sap.ui.model.json.JSONModel(t);e.getView().byId("sectorComboBox").setModel(a)},error:function(e){console.log(e)}})},onReadNatureofActivity:function(){var e=this;var t=this.getOwnerComponent().getModel();t.read("/NatureOfActivitySrv",{success:function(t){var a=new sap.ui.model.json.JSONModel(t);e.getView().byId("NatureofActivity").setModel(a)},error:function(e){console.log(e)}})},onReadSupplierSpendType:function(){var e=this;var t=this.getOwnerComponent().getModel();t.read("/SupplierSpendTypeSrv",{success:function(t){var a=new sap.ui.model.json.JSONModel(t);e.getView().byId("supplierSpendType").setModel(a)},error:function(e){console.log(e)}})},onSave:function(){var e=this.getView();var a=this.getOwnerComponent().getModel();var r=true;var i={validity:e.byId("datePicker").getDateValue(),relatedParty:e.byId("radioGroup").getSelectedButton().getText(),supplierSpendType:e.byId("supplierSpendType").getSelectedKey(),natureOfActivity:e.byId("NatureofActivity").getSelectedKey(),sector:e.byId("sectorComboBox").getSelectedKeys().join(", "),FunctionandSubfunction:e.byId("childMultiComboBox").getSelectedKeys(),panCardNumber:e.byId("panInput").getValue(),gstinNumber:e.byId("gstinInput").getValue(),supplierFullName:e.byId("SupplierNameInput").getValue(),supplierTradeName:e.byId("SuppliertradeNameInput").getValue(),supplierAddress:e.byId("SupplierAddressInput").getValue(),supplierGstAddress:e.byId("SupplierAddressgstInput").getValue(),primaryFirstName:e.byId("PrimaryFirstnameInput").getValue(),primaryLastName:e.byId("PrimaryLastnameInput").getValue(),primaryEmail:e.byId("emailInput").getValue(),primaryPhone:e.byId("numberInput").getValue()};var s=JSON.stringify(i);localStorage.setItem("formData",s);t.show("Form data saved successfully in local storage.");a.setUseBatch(false);var e=this;a.create("/SavingsupplierReqSrv",oNewEntry,{method:"POST",success:function(a){t.show("Form Saved successfully."+a.ID);console.log(a.ID);this.onUploadFile(a.ID);console.log("----------\x3eUpload");e.clearFormFields()}.bind(this),error:function(){t.show("Error while submitting the Form.")}})},onReadDepartments:function(){var e=this;var t=this.getOwnerComponent().getModel();t.read("/departmentsSrv",{success:function(t){var a=new sap.ui.model.json.JSONModel(t);e.getView().setModel(a,"departmentsModel");var r=e.getView().byId("FunctionandSubfunctionComboBox");var i=r.getItems();if(i&&i.length>0){r.setSelectedItem(i[0]);e.onDepartmentChange({getParameter:function(){return i[0]}})}},error:function(e){console.log("Error fetching departments data:",e)}})},onDepartmentChange:function(e){var t=this;var a=e.getParameter("selectedItem");if(a){var r=a.getBindingContext("departmentsModel").getObject();if(r.Functions&&r.Functions.length>0){var i=new sap.ui.model.json.JSONModel({Functions:r.Functions});t.getView().byId("childMultiComboBox").setModel(i,"functionsModel")}else{console.log("No functions available for the selected department.")}}}})});
//# sourceMappingURL=RequestForm.controller.js.map